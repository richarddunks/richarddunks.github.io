<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- <link rel="shortcut icon" href="../../assets/ico/favicon.ico"> -->

    <title>Awesome UNGP Visualization</title>
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <!-- <link href="starter-template.css" rel="stylesheet"> -->
    <link href="css/tradeviz.css" rel="stylesheet">
  </head>

  <body>
    <div class="right-sidebar">
      <div class="weight-value-selector">
        <p id="weight">Net Weight (kg)</p>
        <p id="value">Value</p>
      </div>
      <div class="country-selector">
        <select id="country-list" name="country-list">
          <option value="Albania">Albania</option>
          <option value="Algeria">Algeria</option>
          <option value="Antigua_and_Barbuda">Antigua and Barbuda</option>
          <option value="Argentina">Argentina</option>
          <option value="Armenia">Armenia</option>
          <option value="Aruba">Aruba</option>
          <option value="Australia">Australia</option>
          <option value="Austria">Austria</option>
          <option value="Azerbaijan">Azerbaijan</option>
          <option value="Bahrain">Bahrain</option>
          <option value="Barbados">Barbados</option>
          <option value="Belarus">Belarus</option>
          <option value="Belgium">Belgium</option>
          <option value="Bolivia">Bolivia</option>
          <option value="Bosnia_Herzegovina">Bosnia Herzegovina</option>
          <option value="Brazil">Brazil</option>
          <option value="Brunei_Darussalam">Brunei Darussalam</option>
          <option value="Bulgaria">Bulgaria</option>
          <option value="Burkina_Faso">Burkina Faso</option>
          <option value="Burundi">Burundi</option>
          <option value="Cabo_Verde">Cabo Verde</option>
          <option value="Cameroon">Cameroon</option>
          <option value="Canada">Canada</option>
          <option value="Central_African_Rep">Central African Republic</option>
          <option value="Chile">Chile</option>
          <option value="China">China</option>
          <option value="Colombia">Colombia</option>
          <option value="Croatia">Croatia</option>
          <option value="Cyprus">Cyprus</option>
          <option value="Czech_Rep">Czech Republic</option>
          <option value="Denmark">Denmark</option>
          <option value="Dominica">Dominica</option>
          <option value="Dominican_Rep">Dominican Republic</option>
          <option value="Ecuador">Ecuador</option>
          <option value="Egypt">Egypt</option>
          <option value="El_Salvador">El Salvador</option>
          <option value="Estonia">Estonia</option>
          <option value="Ethiopia">Ethiopia</option>
          <option value="Finland">Finland</option>
          <option value="France">France</option>
          <option value="Georgia">Georgia</option>
          <option value="Germany">Germany</option>
          <option value="Greece">Greece</option>
          <option value="Guatemala">Guatemala</option>
          <option value="Hong_Kong">Hong Kong SAR</option>
          <option value="Hungary">Hungary</option>
          <option value="Iceland">Iceland</option>
          <option value="India">India</option>
          <option value="Indonesia">Indonesia</option>
          <option value="Ireland">Ireland</option>
          <option value="Israel">Israel</option>
          <option value="Italy">Italy</option>
          <option value="Japan">Japan</option>
          <option value="Jordan">Jordan</option>
          <option value="Kazakhstan">Kazakhstan</option>
          <option value="Kenya">Kenya</option>
          <option value="Kyrgyzstan">Kyrgyzstan</option>
          <option value="Latvia">Latvia</option>
          <option value="Lithuania">Lithuania</option>
          <option value="Luxembourg">Luxembourg</option>
          <option value="Macedonia">Macedonia</option>
          <option value="Madagascar">Madagascar</option>
          <option value="Malaysia">Malaysia</option>
          <option value="Mali">Mali</option>
          <option value="Malta">Malta</option>
          <option value="Mauritius">Mauritius</option>
          <option value="Mexico">Mexico</option>
          <option value="Montenegro">Montenegro</option>
          <option value="Morocco">Morocco</option>
          <option value="Mozambique">Mozambique</option>
          <option value="Namibia">Namibia</option>
          <option value="Netherlands">Netherlands</option>
          <option value="New_Caledonia">New Caledonia</option>
          <option value="New_Zealand">New Zealand</option>
          <option value="Nicaragua">Nicaragua</option>
          <option value="Nigeria">Nigeria</option>
          <option value="Norway">Norway</option>
          <option value="Pakistan">Pakistan</option>
          <option value="Panama">Panama</option>
          <option value="Paraguay">Paraguay</option>
          <option value="Peru">Peru</option>
          <option value="Philippines">Philippines</option>
          <option value="Poland">Poland</option>
          <option value="Portugal">Portugal</option>
          <option value="Rep_of_Korea">Republic of Korea</option>
          <option value="Rep_of_Moldova">Republic of Moldova</option>
          <option value="Romania">Romania</option>
          <option value="Russian_Federation">Russian Federation</option>
          <option value="Rwanda">Rwanda</option>
          <option value="Senegal">Senegal</option>
          <option value="Serbia">Serbia</option>
          <option value="Singapore">Singapore</option>
          <option value="Slovakia">Slovakia</option>
          <option value="Slovenia">Slovenia</option>
          <option value="South_Africa">South Africa</option>
          <option value="Spain">Spain</option>
          <option value="Sri_Lanka">Sri Lanka</option>
          <option value="State_of_Palestine">State of Palestine</option>
          <option value="Sweden">Sweden</option>
          <option value="Switzerland">Switzerland</option>
          <option value="Thailand">Thailand</option>
          <option value="Togo">Togo</option>
          <option value="Turkey">Turkey</option>
          <option value="Ukraine">Ukraine</option>
          <option value="United_Kingdom">United Kingdom</option>
          <option value="United_Rep_of_Tanzania">United Republic of Tanzania</option>
          <option value="Uruguay">Uruguay</option>
          <option value="USA">USA</option>
          <option value="Zambia">Zambia</option>
          <option value="Zimbabwe">Zimbabwe</option>
        </select>
      </div>
    </div>
    <div id="dorling"></div>
    <div id="line_graph"></div>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script> 
    <script type="text/javascript">
      var margin = {top: 0, right: 0, bottom: 0, left: 0},
            width = 800 - margin.left - margin.right,
            height = 425 - margin.top - margin.bottom,
            padding = 3;

      //associative array for coloring the regions
      var region_color = { "Americas" : "orange", "Oceania" : "blue", "Africa" : "green", "Asia" : "red", "Europe" : "purple" };

      //for converting the datetime object coming out of the time slider
      var date_position_array = {201001: 0, 201002: 1, 201003: 2, 201004: 3, 201005: 4, 201006: 5, 201007: 6, 201008: 7, 201009: 8, 201010: 9, 201011: 10, 201012: 11, 201101: 12, 201102: 13, 201103: 14, 201104: 15, 201105: 16, 201106: 17, 201107: 18, 201108: 19, 201109: 20, 201110: 21, 201111: 22, 201112: 23, 201201: 24, 201202: 25, 201203: 26, 201204: 27, 201205: 28, 201206: 29, 201207: 30, 201208: 31, 201209: 32, 201210: 33, 201211: 34, 201212: 35, 201301: 36, 201302: 37, 201303: 38, 201304: 39, 201305: 40, 201306: 41, 201307: 42, 201308: 43, 201309: 44, 201310: 45, 201311: 46, 201312: 47};

      var projection = d3.geo.mercator()
                              .scale((width + 1) / 2 / Math.PI)
                              .translate([(width / 2), (height / 2) + 65])
                              .precision(.1);

      var path = d3.geo.path()
          .projection(projection);

      var graticule = d3.geo.graticule();

      var svg = d3.select("div#dorling").append("svg")
          .attr("class","dorling")
          .attr("width", width)
          .attr("height", height);
    
      //global variables for checking data types
      // var global_country_sum;
      // var global_country_data;
      // var global_sum_min;
      // var global_sum_max;

      var centroid_data_path = "data/reporters_centroid.csv";
      // function set_centroid_data() {
      //   d3.csv(, function(data){
      //     centroid_data = data;
      //   }
      //   )};
      // set_centroid_data();

      var range_min;
      var range_max;

      var rScale_min = 1.5;
      var rScale_max = 40;

      var net_weight_flag = true; //flag to toggle net_weight and usd_value

      var mapFilename = "data/world-50m.json";
      var jsonFilename = "data/country_json/albania.json";
      var slice_start = 0;
      var slice_end = 48;

      // var brush_change = d3.select("#extent");

      //reset the slice_start and slice_end with values from brush
      var change_date_range = function() {
       slice_start = date_position_array[range_min.toJSON().slice(0,4) + range_min.toJSON().slice(5,7)];
       slice_end = date_position_array[range_max.toJSON().slice(0,4) + range_max.toJSON().slice(5,7)];
       // svg.selectAll("circle.country")
       update_sum();
      };

      //draw base map
      function display_map() {  
       d3.json(mapFilename, function(error, world) {
        svg.insert("path", ".graticule")
            .datum(topojson.feature(world, world.objects.land))
            .attr("class", "land")
            .attr("d", path);

        svg.insert("path", ".graticule")
            .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
            .attr("class", "boundary")
            .attr("d", path);

        display_sum();

        })
      } //end function display_map

      display_map(); //call map function to draw the base map

      //display the circles and scale radius based on sum for the first time
      function display_sum() {
        d3.json(jsonFilename, function(error, country_data) {
          
          var country_sum = {};
          for (var i = 0,len = country_data.length; i < len; i++ ) {
            if (country_data[i].partner_country != "undefined") {
              if (net_weight_flag == true) { //sum the net_weight based on flag
                country_sum[country_data[i].partner_country] = d3.sum(country_data[i].net_weight.slice(slice_start,slice_end));
              } else { //sum the usd_value based on the flag
                country_sum[country_data[i].partner_country] = d3.sum(country_data[i].usd_value.slice(slice_start,slice_end));
              }
            }
          }

          var sum_min = Math.sqrt(d3.min(d3.values(country_sum)));
          var sum_max = Math.sqrt(d3.max(d3.values(country_sum)));

          // global_sum_min = sum_min;
          // global_sum_max = sum_max;

          var rScale = d3.scale
                      .linear()
                      .domain([sum_min,sum_max]) //.nice to round up! 
                      .range([rScale_min,rScale_max]);

          //assign local variables to global variables in order to debug
          // global_country_data = country_data;
          // global_country_sum = country_sum;

          display_country_circles(country_sum,rScale);
          draw_legend(rScale, sum_max, sum_min);
        });//end json call

      } //end function display_sum

      //subsequent updates to the circles only changing radius, updating the tooltip, and rescaling the leged
      function update_sum() {
          d3.json(jsonFilename, function(error, country_data) {
          
          var country_sum = {};
          for (var i = 0,len = country_data.length; i < len; i++ ) {
            if (country_data[i].partner_country != "undefined") {
              if (net_weight_flag == true) { //sum the net_weight based on flag
                country_sum[country_data[i].partner_country] = d3.sum(country_data[i].net_weight.slice(slice_start,slice_end));
              } else { //sum the usd_value based on the flag
                country_sum[country_data[i].partner_country] = d3.sum(country_data[i].usd_value.slice(slice_start,slice_end));
              }
            }
          }


          var sum_min = Math.sqrt(d3.min(d3.values(country_sum)));
          var sum_max = Math.sqrt(d3.max(d3.values(country_sum)));

          // global_sum_min = sum_min;
          // global_sum_max = sum_max;

          var rScale = d3.scale
                      .linear()
                      .domain([sum_min,sum_max]) //.nice to round up! 
                      .range([rScale_min,rScale_max]);

          //assign local variables to global variables in order to debug
          // global_country_data = country_data;
          // global_country_sum = country_sum;

          d3.csv(centroid_data_path, function(data){
            var tip = d3.tip()
                      .attr("class", "d3-tip")
                      .html(function(d) { 
                        if (country_sum[d.country] != undefined){
                          return d.country + "</br>" + country_sum[d.country] + "kg"; 
                        };
                      });

            svg.selectAll("circle.country")
                .data(data)
                .attr("r", function(d){
                  if (country_sum[d.country]) {
                    return rScale(Math.sqrt(country_sum[d.country]));
                  } else {
                    return 0;
                  }
                })
                .on('mouseover', tip.show) 
                .on('mouseout', tip.hide); 
            
            svg.call(tip);
              }); //end of d3.csv
          update_legend(rScale,sum_max, sum_min);

          });//end json call
      } //end function update_sum


      //display the country circles based on passed values and scale
      function display_country_circles(country_sum,rScale) {
        d3.csv(centroid_data_path, function(data){
          var tip = d3.tip()
                      .attr("class", "d3-tip")
                      .html(function(d) { 
                        if (country_sum[d.country] != undefined){
                          return d.country + "</br>" + country_sum[d.country] + "kg"; 
                        };
                      });

          svg.selectAll("circle.country")
                  .data(data)
                  .enter()
                  .append("circle")
                  .attr("class","country")
                  .attr("cx", function(d){
                    return projection([d.lon, d.lat])[0];
                  })
                  .attr("cy", function(d){
                    return projection([d.lon, d.lat])[1];
                  })
                  .attr("r", function(d){
                    if (country_sum[d.country]) {
                      return rScale(Math.sqrt(country_sum[d.country]));
                    } else {
                      return 0;
                    }
                  })
                  .style("fill",function(d){
                    return region_color[d.region];
                  })
                  .style("opacity",0.6)
                  .on('mouseover', tip.show)
                  .on('mouseout', tip.hide);

          svg.call(tip); //call tooltip function to load
        });//end csv function  
      } //end function display_country_circles

      //initial draw of the legend
      function draw_legend(rScale, sum_max, sum_min) {
        var sum_avg = (sum_max + sum_min) / 2;

        svg.selectAll("circle.legend")
              .data([1])
              .enter()
              .append("circle")
              .attr("class","legend")
              .attr("cx",rScale(sum_max) + padding)
              .attr("cy",height)
              .attr("r",function(d){
               if (sum_avg == 0) {
                  return 0;
                } else if (Math.abs(100000000 - sum_avg) < Math.abs(50000000 - sum_avg)) {
                  return rScale(100000000); //10^8
                } else if (Math.abs(50000000 - sum_avg) < Math.abs(10000000 - sum_avg)) {
                  return rScale(50000000); //5 * 10^7
                } else if (Math.abs(10000000 - sum_avg) < Math.abs(5000000 - sum_avg)) {
                  return rScale(10000000); //10^7
                } else if (Math.abs(5000000 - sum_avg) < Math.abs(1000000 - sum_avg)) {
                  return rScale(5000000); //5 * 10^6
                } else if (Math.abs(1000000 - sum_avg) < Math.abs(500000 - sum_avg)) {
                  return rScale(1000000); //10^6
                } else if (Math.abs(500000 - sum_avg) < Math.abs(100000 - sum_avg)) {
                  return rScale(500000); //5 * 10^5
                } else if (Math.abs(100000 - sum_avg) < Math.abs(50000 - sum_avg)) {
                  return rScale(100000); //10^5
                } else if (Math.abs(50000 - sum_avg) < Math.abs(10000 - sum_avg)) {
                  return rScale(50000); //5 * 10^4
                } else if (Math.abs(10000 - sum_avg) < Math.abs(5000 - sum_avg)) {
                  return rScale(10000); //10^4
                } else if (Math.abs(5000 - sum_avg) < Math.abs(1000 - sum_avg)) {
                  return rScale(5000); //5 * 10^3
                } else {
                  return rScale(1000); //10^3
                }
              })
              .attr("stroke","black")
              // .attr("stroke-width","2px")
              .attr("fill","none");
          
          svg.selectAll("text.legend-text")
              .data([1])
              .enter()
              .append("text")
              .attr("class","legend-text")
              .attr("x",function(){
                return rScale(sum_max) - (padding * 5);
              })
              .attr("y", function(){
                return height - rScale(sum_max);
              })
              .text(function(){
                if (sum_avg == 0) {
                  return "No Trade Reported";
                } else if (Math.abs(100000000 - sum_avg) < Math.abs(50000000 - sum_avg)) {
                  return "1000T";//rScale(100000000); //10^8 -> 10^16
                } else if (Math.abs(50000000 - sum_avg) < Math.abs(10000000 - sum_avg)) {
                  return " 250T";//rScale(50000000); //5 * 10^7 -> 10^14
                } else if (Math.abs(10000000 - sum_avg) < Math.abs(5000000 - sum_avg)) {
                  return " 10T "; //rScale(10000000); //10^7
                } else if (Math.abs(5000000 - sum_avg) < Math.abs(1000000 - sum_avg)) {
                  return " 2.5T"; //rScale(5000000); //5 * 10^6
                } else if (Math.abs(1000000 - sum_avg) < Math.abs(500000 - sum_avg)) {
                  return " 100B"; //rScale(1000000); //10^6
                } else if (Math.abs(500000 - sum_avg) < Math.abs(100000 - sum_avg)) {
                  return " 25B "; //rScale(500000); //5 * 10^5
                } else if (Math.abs(100000 - sum_avg) < Math.abs(50000 - sum_avg)) {
                  return " 10B "; //rScale(100000); //10^5
                } else if (Math.abs(50000 - sum_avg) < Math.abs(10000 - sum_avg)) {
                  return " 2.5B"; //rScale(50000); //5 * 10^4
                } else if (Math.abs(10000 - sum_avg) < Math.abs(5000 - sum_avg)) {
                  return " 100M"; //rScale(10000); //10^4
                } else if (Math.abs(5000 - sum_avg) < Math.abs(1000 - sum_avg)) {
                  return " 25M "; //rScale(5000); //5 * 10^3
                } else {
                  return " 10M "; //rScale(1000); //10^3
                }
              });
      } //end function draw_legend

      //update the legend when updating the graph
      function update_legend(rScale, sum_max, sum_min) {
        var sum_avg = (sum_max + sum_min) / 2;

        svg.select("circle.legend")
            .data([1])
            .attr("cx",rScale(sum_max) + padding)
            // .attr("fill","none")
            .attr("r",function(d){
              if (sum_avg == 0) {
                return 0;
              } else if (Math.abs(100000000 - sum_avg) < Math.abs(50000000 - sum_avg)) {
                return rScale(100000000); //10^8
              } else if (Math.abs(50000000 - sum_avg) < Math.abs(10000000 - sum_avg)) {
                return rScale(50000000); //5 * 10^7
              } else if (Math.abs(10000000 - sum_avg) < Math.abs(5000000 - sum_avg)) {
                return rScale(10000000); //10^7
              } else if (Math.abs(5000000 - sum_avg) < Math.abs(1000000 - sum_avg)) {
                return rScale(5000000); //5 * 10^6
              } else if (Math.abs(1000000 - sum_avg) < Math.abs(500000 - sum_avg)) {
                return rScale(1000000); //10^6
              } else if (Math.abs(500000 - sum_avg) < Math.abs(100000 - sum_avg)) {
                return rScale(500000); //5 * 10^5
              } else if (Math.abs(100000 - sum_avg) < Math.abs(50000 - sum_avg)) {
                return rScale(100000); //10^5
              } else if (Math.abs(50000 - sum_avg) < Math.abs(10000 - sum_avg)) {
                return rScale(50000); //5 * 10^4
              } else if (Math.abs(10000 - sum_avg) < Math.abs(5000 - sum_avg)) {
                return rScale(10000); //10^4
              } else if (Math.abs(5000 - sum_avg) < Math.abs(1000 - sum_avg)) {
                return rScale(5000); //5 * 10^3
              } else {
                return rScale(1000); //10^3
              }
            })

        svg.select("text.legend-text")
            .data([1])
            .attr("x",function(){
              return rScale(sum_max) - (padding * 5);
            })
            .attr("y", function(){
              return height - rScale(sum_max);
            })
            .text(function(){
              if (sum_avg == 0) {
                return "0";
              } else if (Math.abs(100000000 - sum_avg) < Math.abs(50000000 - sum_avg)) {
                return "1000T";//rScale(100000000); //10^8 -> 10^16
              } else if (Math.abs(50000000 - sum_avg) < Math.abs(10000000 - sum_avg)) {
                return " 250T";//rScale(50000000); //5 * 10^7 -> 10^14
              } else if (Math.abs(10000000 - sum_avg) < Math.abs(5000000 - sum_avg)) {
                return " 10T "; //rScale(10000000); //10^7
              } else if (Math.abs(5000000 - sum_avg) < Math.abs(1000000 - sum_avg)) {
                return " 2.5T"; //rScale(5000000); //5 * 10^6
              } else if (Math.abs(1000000 - sum_avg) < Math.abs(500000 - sum_avg)) {
                return " 100B"; //rScale(1000000); //10^6
              } else if (Math.abs(500000 - sum_avg) < Math.abs(100000 - sum_avg)) {
                return " 25B "; //rScale(500000); //5 * 10^5
              } else if (Math.abs(100000 - sum_avg) < Math.abs(50000 - sum_avg)) {
                return " 10B "; //rScale(100000); //10^5
              } else if (Math.abs(50000 - sum_avg) < Math.abs(10000 - sum_avg)) {
                return " 2.5B"; //rScale(50000); //5 * 10^4
              } else if (Math.abs(10000 - sum_avg) < Math.abs(5000 - sum_avg)) {
                return " 100M"; //rScale(10000); //10^4
              } else if (Math.abs(5000 - sum_avg) < Math.abs(1000 - sum_avg)) {
                return " 25M "; //rScale(5000); //5 * 10^3
              } else {
                return " 10M "; //rScale(1000); //10^3
              }
            });

      } //end function update_legend

      var dropdown = d3.select("#country-list"); //listener for change in menu options

      //handles change of the country based on the dropdown menu values
      function change () {
        var country = d3.event.target.value; //get the new value from the dropdown menu
        country = country.toLowerCase(); //reformat the value


        jsonFilename = "data/country_json/" + country + ".json"; //concatenate the json name and bind to global variable
        
        //reset the length of time displayed on the dorling to the full 48 months
        slice_start = 0; 
        slice_end = 48; 

        update_sum(); //rerun the draw on update
        line_draw(); //redraw the line graphs for the new country
      } //end function change

      dropdown.on("change", change); //event listener

      

      
      // function set_net_weight_false () {
      //   alert("You selected value");
      //   //set
      //   net_weight_flag = false;
      //   console.log(net_weight_flag);
      // }


      //______Start Line Graph Code 
      function line_draw() {
        d3.json(jsonFilename, function(error, data){
          d3.selectAll("#line_graph").remove().transition(); //Transition so that it redraws graph in same place

          var margin = {top: 15, right: 14, bottom: 50, left: 75},
                width = 800 - margin.left - margin.right,
                height = 300 - margin.top - margin.bottom;

          var x = d3.time.scale()
              .domain([new Date(2009, 12) , new Date(2013, 11)])
              .range([0, width]);

          var brush = d3.svg.brush()
              .x(x)
              .on("brushend", brushended);

          var svg = d3.select("body").append("svg").attr("id","line_graph")
              .attr("class","line_chart")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("class","whole")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          //Line Graph vars
          //some type of if function here to adjust the input if it is weight of value input
          var max = d3.max(d3.max(data, function(d){ if (d.partner_country == undefined){return d.net_weight;};}));

          //Y-Scale Function Defined based on max 
          var yScale = d3.scale
                        .linear()
                        .domain([0,max]).nice() //.nice to round up! 
                        .range([height,0]);

          //Create the array for x date values: 
          date_range = [new Date(2009, 12), new Date(2010, 1), new Date(2010, 2), new Date(2010, 3), new Date(2010, 4), new Date(2010, 5), new Date(2010, 6), new Date(2010, 7), new Date(2010, 8), new Date(2010, 9), new Date(2010, 10), new Date(2010, 11), new Date(2010, 12), new Date(2011, 1), new Date(2011, 2), new Date(2011, 3), new Date(2011, 4), new Date(2011, 5), new Date(2011, 6), new Date(2011, 7), new Date(2011, 8), new Date(2011, 9), new Date(2011, 10), new Date(2011, 11), new Date(2011, 12),new Date(2012, 1), new Date(2012, 2), new Date(2012, 3), new Date(2012, 4), new Date(2012, 5), new Date(2012, 6), new Date(2012, 7), new Date(2012, 8), new Date(2012, 9), new Date(2012, 10), new Date(2012, 11), new Date(2012, 12),new Date(2013, 1), new Date(2013, 2), new Date(2013, 3), new Date(2013, 4), new Date(2013, 5), new Date(2013, 6), new Date(2013, 7), new Date(2013, 8), new Date(2013, 9), new Date(2013, 10), new Date(2013, 11)]  ;
          
          //Grid lines
          svg.append("g")
              .attr("class", "x grid")
              .attr("transform", "translate(0," + height + ")")
              .call(d3.svg.axis()
                  .scale(x)
                  .orient("bottom")
                  .ticks(d3.time.month)
                  .tickSize(-height)
                  .tickFormat(""))

          svg.append("g")
              .attr("class", "y grid")
              .call(d3.svg.axis()
                  .scale(yScale)
                  .orient("left")
                  .tickSize(-width)
                  .tickFormat(""));

          var line = d3.svg.line().x(function(d,i) { return x(date_range[i]); })
                                  .y(function(d) {  return yScale(d); });      

          //line for each partner country
          svg.selectAll("line.partner").data(data).enter()
                              .append("path")
                              .attr("d", function(d) {
                                if (d.partner_country != undefined) { 
                                  // console.log("I'm in the draw function"); 
                                  return line(d.net_weight);
                                };
                              })   
                              .attr("class","partner")
                              .attr("id",function(d){
                                if (d.partner_country != undefined) {
                                  return d.partner_country;
                                };
                              })
                              .attr("stroke", "gray")
                              .attr("stroke-width", 1)
                              .attr("fill", "none");

          //Aggregate line for reporting country -> still draws lots of unnecessary lines
          svg.selectAll("line.reporter").data(data).enter()
                             .append("path")
                             .attr("d", function(d) {
                                if (d.reporting_country) {
                                  return line(d.net_weight);
                                };
                              })   
                             .attr("class","reporter")
                             .attr("stroke", "red")
                             .attr("stroke-width", 1)
                             .attr("fill", "none");

          //y-axis
          var yAxis = d3.svg.axis();
          yAxis.scale(yScale).orient("left").ticks(10);
          svg.append("g").attr("class","y axis")
              .attr("transform", "translate(" - margin.right + ",0)").call(yAxis);

          //x-axis
          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(d3.svg.axis()
                .scale(x)
                .orient("bottom")
                .ticks(d3.time.month,2)
                .tickFormat(d3.time.format("%b %Y"))
                .tickPadding(0))
            .selectAll("text")
              .attr("x", -1)
              .style("text-anchor", "end")
              .attr("dx", "-.8em")
              .attr("dy", ".15em")
              .attr("transform", function(d) {
                  return "rotate(-45)" 
                });

          //Highlight brushed area
          var gBrush = svg.append("g")
              .attr("class", "brush")
              .call(brush)
              .call(brush.event);

          gBrush.selectAll("rect")
              .attr("height", height);

           //Brushing function with snapping
          function brushended() {

            if (!d3.event.sourceEvent) return; // only transition after input
            var extent0 = brush.extent(),
                extent1 = extent0.map(d3.time.month.round);
       
            // if empty when rounded, use floor & ceil instead
            if (extent1[0] >= extent1[1]) {
                  extent1[0] = d3.time.month.floor(extent0[0]);
                  extent1[1] = d3.time.month.ceil(extent0[1]);       
                    };

            range_min = extent1[0];
            range_max = extent1[1];

            change_date_range();


            d3.select(this).transition()
               .call(brush.extent(extent1))
               .call(brush.event);     
          }; //end function brushended

        }); //end json
      } //end function line_draw
//______End Line Graph Code 


      line_draw(); //draw the lines

      // function set_net_weight_flag(flag) {
      //   if (flag == true) {
      //     alert("You selected net_weight")
      //     net_weight_flag = true;
      //   } else {
      //     alert("You selected value");
      //     net_weight_flag = false;
      //   }

      //   console.log(net_weight_flag);
      // }

      var select_weight = d3.select("p#weight"); //listener for net_weight
      var select_value = d3.select("p#value"); //listener for value

      
      select_weight.on("click",function(){
        alert("you selected weight");
        net_weight_flag = true;
        console.log(net_weight_flag);
        update_sum();
      });

      select_value.on("click",function() {
        alert("you selected value");
        net_weight_flag = false;
        console.log(net_weight_flag);
        update_sum();
      });


    </script>

  </body>
