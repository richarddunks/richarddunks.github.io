<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- <link rel="shortcut icon" href="../../assets/ico/favicon.ico"> -->

    <title>Awesome UNGP Visualization</title>
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <!-- <link href="starter-template.css" rel="stylesheet"> -->
    <style>

      svg.dorling,
      svg.line_chart {
        margin-left:1.5em;
        margin-top:1em;
      }

      .axis text {
        font: 11px sans-serif;
      }

      .axis path {
        display: none;
      }

      .axis line {
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .grid line,
      .grid path {
        fill: none;
        stroke: #C0C0C0;
        shape-rendering: crispEdges;
      }

      .grid .minor.tick line {
        stroke-opacity: .5;
      }

      .brush .extent {
        fill-opacity: .125;
        shape-rendering: crispEdges;
      }

      .graticule {
        fill: none;
        stroke: #777;
        stroke-opacity: .5;
        stroke-width: .5px;
      }

      .land {
        fill: #E6E6E6;
      }

      .boundary {
        fill: none;
        stroke: #fff;
        stroke-width: 1px;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
        }

      .axis text {
        font-family: sans-serif;
        font-size: 11px;
        }
      
      rect:hover {
        fill:orange;
      }
      
      .brush .extent {
      stroke: #fff;
      fill-opacity: .125;
      shape-rendering: crispEdges;
      }
      /* tooltip */
      .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 2px;
      }

      /* Creates a small triangle extender for the tooltip 
      .d3-tip:after {
      box-sizing: border-box;
      display: inline;
      font-size: 10px;
      width: 100%;
      line-height: 1;
      color: rgba(0, 0, 0, 0.8);
      content: "\25BC";
      position: absolute;
      text-align: center;
      }

      Style northward tooltips differently 
      .d3-tip.n:after {
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
      }
      */


    </style>

  </head>

  <body>
    <!-- d3 reference -->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script> 

    <div class="container">
    <script type="text/javascript" id="line_chart">
      var margin = {top: 0, right: 0, bottom: 0, left: 0},
          width = 960 - margin.left - margin.right,
          height = 550 - margin.top - margin.bottom,
          padding = 3;

      var region_color = { "Americas" : "orange", "Oceania" : "blue", "Africa" : "green", "Asia" : "red", "Europe" : "purple" };

      var date_position_array = {201001: 0, 201002: 1, 201003: 2, 201004: 3, 201005: 4, 201006: 5, 201007: 6, 201008: 7, 201009: 8, 201010: 9, 201011: 10, 201012: 11, 201101: 12, 201102: 13, 201103: 14, 201104: 15, 201105: 16, 201106: 17, 201107: 18, 201108: 19, 201109: 20, 201110: 21, 201111: 22, 201112: 23, 201201: 24, 201202: 25, 201203: 26, 201204: 27, 201205: 28, 201206: 29, 201207: 30, 201208: 31, 201209: 32, 201210: 33, 201211: 34, 201212: 35, 201301: 36, 201302: 37, 201303: 38, 201304: 39, 201305: 40, 201306: 41, 201307: 42, 201308: 43, 201309: 44, 201310: 45, 201311: 46, 201312: 47};

      var projection = d3.geo.mercator()
                              .scale((width + 1) / 2 / Math.PI)
                              .translate([(width / 2), (height / 2) + 65])
                              .precision(.1);

      var path = d3.geo.path()
          .projection(projection);

      var graticule = d3.geo.graticule();

      var svg = d3.select("body").append("svg")
          .attr("class","dorling")
          .attr("width", width)
          .attr("height", height);
    
      //global variables for checking data types
      var global_country_sum;
      var global_country_data;
      var global_sum_min;
      var global_sum_max;

      var jsonFilename = "data/country_json/albania.json";
      var slice_start = 0;
      var slice_end = 48;

      d3.json("data/world-50m.json", function(error, world) {
        svg.insert("path", ".graticule")
            .datum(topojson.feature(world, world.objects.land))
            .attr("class", "land")
            .attr("d", path);

        svg.insert("path", ".graticule")
            .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
            .attr("class", "boundary")
            .attr("d", path);

        d3.json(jsonFilename, function(error, country_data) {
          
          var country_sum = {};
          for (var i = 0,len = country_data.length; i < len; i++ ) {
            if (country_data[i].partner_country != "undefined") {
              country_sum[country_data[i].partner_country] = d3.sum(country_data[i].net_weight.slice(slice_start,slice_end));
            }
          } //still generating some random undefined value (total sum?)

          var sum_min = Math.sqrt(d3.min(d3.values(country_sum)));
          var sum_max = Math.sqrt(d3.max(d3.values(country_sum)));

          global_sum_min = sum_min;
          global_sum_max = sum_max;

          var rScale = d3.scale
                      .linear()
                      .domain([sum_min,sum_max]) //.nice to round up! 
                      .range([2,50]);



          var tip = d3.tip()
              .attr("class", "d3-tip")
              .html(function(d) { 
                return d.country + "</br>" + country_sum[d.country] + "kg"; 
              }); // not sure what 
          svg.call(tip);
          
          //assign local variables to global variables in order to debug
          global_country_data = country_data;
          global_country_sum = country_sum;
          
          //y = height; x = rscale(sum_max)
          svg.selectAll("circle.legend")
              .data([1])
              .enter()
              .append("circle")
              .attr("class","legend")
              .attr("cx",rScale(sum_max) + padding)
              .attr("cy",height)
              .attr("r",function(d){
                var sum_avg = (sum_max + sum_min) / 2;
                // var sum_spread = sum_max - sum_min;
                if (Math.abs(100000000 - sum_avg) < Math.abs(50000000 - sum_avg)) {
                  return rScale(100000000); //10^8
                } else if (Math.abs(50000000 - sum_avg) < Math.abs(10000000 - sum_avg)) {
                  return rScale(50000000); //5 * 10^7
                } else if (Math.abs(10000000 - sum_avg) < Math.abs(5000000 - sum_avg)) {
                  return rScale(10000000); //10^7
                } else if (Math.abs(5000000 - sum_avg) < Math.abs(1000000 - sum_avg)) {
                  return rScale(5000000); //5 * 10^6
                } else if (Math.abs(1000000 - sum_avg) < Math.abs(500000 - sum_avg)) {
                  return rScale(1000000); //10^6
                } else if (Math.abs(500000 - sum_avg) < Math.abs(100000 - sum_avg)) {
                  return rScale(500000); //5 * 10^5
                } else if (Math.abs(100000 - sum_avg) < Math.abs(50000 - sum_avg)) {
                  return rScale(100000); //10^5
                } else if (Math.abs(50000 - sum_avg) < Math.abs(10000 - sum_avg)) {
                  return rScale(50000); //5 * 10^4
                } else if (Math.abs(10000 - sum_avg) < Math.abs(5000 - sum_avg)) {
                  return rScale(10000); //10^4
                } else if (Math.abs(5000 - sum_avg) < Math.abs(1000 - sum_avg)) {
                  return rScale(5000); //5 * 10^3
                } else {
                  return rScale(1000); //10^3
                }
              })
              .attr("stroke","black")
              // .attr("stroke-width","2px")
              .attr("fill","none");
          
          svg.selectAll("text.legend-text")
              .data([1])
              .enter()
              .append("text")
              .attr("class","legend-text")
              .attr("x",function(){
                return rScale(sum_max) - (padding * 5);
              })
              .attr("y", function(){
                return height - rScale(sum_max);
              })
              .text(function(){
                var sum_avg = (sum_max + sum_min) / 2;
                // var sum_spread = sum_max - sum_min;
                if (Math.abs(100000000 - sum_avg) < Math.abs(50000000 - sum_avg)) {
                  return "1000T";//rScale(100000000); //10^8 -> 10^16
                } else if (Math.abs(50000000 - sum_avg) < Math.abs(10000000 - sum_avg)) {
                  return " 250T";//rScale(50000000); //5 * 10^7 -> 10^14
                } else if (Math.abs(10000000 - sum_avg) < Math.abs(5000000 - sum_avg)) {
                  return " 10T "; //rScale(10000000); //10^7
                } else if (Math.abs(5000000 - sum_avg) < Math.abs(1000000 - sum_avg)) {
                  return " 2.5T"; //rScale(5000000); //5 * 10^6
                } else if (Math.abs(1000000 - sum_avg) < Math.abs(500000 - sum_avg)) {
                  return " 100B"; //rScale(1000000); //10^6
                } else if (Math.abs(500000 - sum_avg) < Math.abs(100000 - sum_avg)) {
                  return " 25B "; //rScale(500000); //5 * 10^5
                } else if (Math.abs(100000 - sum_avg) < Math.abs(50000 - sum_avg)) {
                  return " 10B "; //rScale(100000); //10^5
                } else if (Math.abs(50000 - sum_avg) < Math.abs(10000 - sum_avg)) {
                  return " 2.5B"; //rScale(50000); //5 * 10^4
                } else if (Math.abs(10000 - sum_avg) < Math.abs(5000 - sum_avg)) {
                  return " 100M"; //rScale(10000); //10^4
                } else if (Math.abs(5000 - sum_avg) < Math.abs(1000 - sum_avg)) {
                  return " 25M "; //rScale(5000); //5 * 10^3
                } else {
                  return " 10M "; //rScale(1000); //10^3
                }
              });

          d3.csv("data/reporters_centroid.csv", function(data){
            svg.selectAll("circle.country")
                .data(data)
                .enter()
                .append("circle")
                .attr("class","country")
                .attr("cx", function(d){
                  return projection([d.lon, d.lat])[0];
                })
                .attr("cy", function(d){
                  return projection([d.lon, d.lat])[1];
                })
                .attr("r", function(d){
                  if (country_sum[d.country]) {
                    return rScale(Math.sqrt(country_sum[d.country]));
                  } else {
                    return 0;
                  }
                })
                .style("fill",function(d){
                  return region_color[d.region];
                })
                .style("opacity",0.6)
                .on('mouseover', tip.show) //tooltip 
                .on('mouseout', tip.hide); // tooltip
            }); //end reporters_centroid.csv
        }); //end country json
      
      var dropdown = d3.select("#country-list");
      
      var change = function() {
        var country = d3.event.target.value;
        country = country.toLowerCase();

        jsonFilename = "data/country_json/" + country + ".json";

        d3.json(jsonFilename, function(error, country_data) {
          
          var country_sum = {};
          for (var i = 0,len = country_data.length; i < len; i++ ) {
            if (country_data[i].partner_country != "undefined") {
              country_sum[country_data[i].partner_country] = d3.sum(country_data[i].net_weight.slice(slice_start,slice_end));
            }
          } //still generating some random undefined value (total sum?)

          var sum_min = Math.sqrt(d3.min(d3.values(country_sum)));
          var sum_max = Math.sqrt(d3.max(d3.values(country_sum)));

          global_sum_min = sum_min;
          global_sum_max = sum_max;

          var rScale = d3.scale
                      .linear()
                      .domain([sum_min,sum_max]) //.nice to round up! 
                      .range([2,50]);

          var tip = d3.tip()
              .attr("class", "d3-tip")
              .html(function(d) { 
                return d.country + "</br>" + country_sum[d.country] + "kg"; 
              });
          svg.call(tip);

          global_country_data = country_data;
          global_country_sum = country_sum;

          svg.select("circle.legend")
              .data([1])
              .attr("cx",rScale(sum_max) + padding)
              // .attr("fill","none")
              .attr("r",function(d){
                var sum_avg = (sum_max + sum_min) / 2;
                var sum_spread = sum_max - sum_min;
                if (Math.abs(100000000 - sum_avg) < Math.abs(50000000 - sum_avg)) {
                  return rScale(100000000); //10^8
                } else if (Math.abs(50000000 - sum_avg) < Math.abs(10000000 - sum_avg)) {
                  return rScale(50000000); //5 * 10^7
                } else if (Math.abs(10000000 - sum_avg) < Math.abs(5000000 - sum_avg)) {
                  return rScale(10000000); //10^7
                } else if (Math.abs(5000000 - sum_avg) < Math.abs(1000000 - sum_avg)) {
                  return rScale(5000000); //5 * 10^6
                } else if (Math.abs(1000000 - sum_avg) < Math.abs(500000 - sum_avg)) {
                  return rScale(1000000); //10^6
                } else if (Math.abs(500000 - sum_avg) < Math.abs(100000 - sum_avg)) {
                  return rScale(500000); //5 * 10^5
                } else if (Math.abs(100000 - sum_avg) < Math.abs(50000 - sum_avg)) {
                  return rScale(100000); //10^5
                } else if (Math.abs(50000 - sum_avg) < Math.abs(10000 - sum_avg)) {
                  return rScale(50000); //5 * 10^4
                } else if (Math.abs(10000 - sum_avg) < Math.abs(5000 - sum_avg)) {
                  return rScale(10000); //10^4
                } else if (Math.abs(5000 - sum_avg) < Math.abs(1000 - sum_avg)) {
                  return rScale(5000); //5 * 10^3
                } else {
                  return rScale(1000); //10^3
                }
              })
console.log(rScale(10000));
          svg.select("text.legend-text")
              .data([1])
              .attr("x",function(){
                return rScale(sum_max) - (padding * 5);
              })
              .attr("y", function(){
                return height - rScale(sum_max);
                // (function(){
                  
                //   return rScale(10000);
                // })
              })
                  
                  // function(){
                  // var sum_avg = (sum_max + sum_min) / 2;
                  // if (Math.abs(100000000 - sum_avg) < Math.abs(50000000 - sum_avg)) {
                  //   return 100000000; //10^8
                  // } else if (Math.abs(50000000 - sum_avg) < Math.abs(10000000 - sum_avg)) {
                  //   return 50000000; //5 * 10^7
                  // } else if (Math.abs(10000000 - sum_avg) < Math.abs(5000000 - sum_avg)) {
                  //   return 10000000; //10^7
                  // } else if (Math.abs(5000000 - sum_avg) < Math.abs(1000000 - sum_avg)) {
                  //   return 5000000; //5 * 10^6
                  // } else if (Math.abs(1000000 - sum_avg) < Math.abs(500000 - sum_avg)) {
                  //   return 1000000; //10^6
                  // } else if (Math.abs(500000 - sum_avg) < Math.abs(100000 - sum_avg)) {
                  //   return 500000; //5 * 10^5
                  // } else if (Math.abs(100000 - sum_avg) < Math.abs(50000 - sum_avg)) {
                  //   return 100000; //10^5
                  // } else if (Math.abs(50000 - sum_avg) < Math.abs(10000 - sum_avg)) {
                  //   return 50000; //5 * 10^4
                  // } else if (Math.abs(10000 - sum_avg) < Math.abs(5000 - sum_avg)) {
                  //   return 10000; //10^4
                  // } else if (Math.abs(5000 - sum_avg) < Math.abs(1000 - sum_avg)) {
                  //   return 5000; //5 * 10^3
                  // } else {
                  //   return 1000; //10^3
                  // }
                // })
                // )
              // })
              .text(function(){
                var sum_avg = (sum_max + sum_min) / 2;
                // var sum_spread = sum_max - sum_min;
                if (Math.abs(100000000 - sum_avg) < Math.abs(50000000 - sum_avg)) {
                  return "1000T";//rScale(100000000); //10^8 -> 10^16
                } else if (Math.abs(50000000 - sum_avg) < Math.abs(10000000 - sum_avg)) {
                  return " 250T";//rScale(50000000); //5 * 10^7 -> 10^14
                } else if (Math.abs(10000000 - sum_avg) < Math.abs(5000000 - sum_avg)) {
                  return " 10T "; //rScale(10000000); //10^7
                } else if (Math.abs(5000000 - sum_avg) < Math.abs(1000000 - sum_avg)) {
                  return " 2.5T"; //rScale(5000000); //5 * 10^6
                } else if (Math.abs(1000000 - sum_avg) < Math.abs(500000 - sum_avg)) {
                  return " 100B"; //rScale(1000000); //10^6
                } else if (Math.abs(500000 - sum_avg) < Math.abs(100000 - sum_avg)) {
                  return " 25B "; //rScale(500000); //5 * 10^5
                } else if (Math.abs(100000 - sum_avg) < Math.abs(50000 - sum_avg)) {
                  return " 10B "; //rScale(100000); //10^5
                } else if (Math.abs(50000 - sum_avg) < Math.abs(10000 - sum_avg)) {
                  return " 2.5B"; //rScale(50000); //5 * 10^4
                } else if (Math.abs(10000 - sum_avg) < Math.abs(5000 - sum_avg)) {
                  return " 100M"; //rScale(10000); //10^4
                } else if (Math.abs(5000 - sum_avg) < Math.abs(1000 - sum_avg)) {
                  return " 25M "; //rScale(5000); //5 * 10^3
                } else {
                  return " 10M "; //rScale(1000); //10^3
                }
              });

          d3.csv("data/reporters_centroid.csv", function(data){
            svg.selectAll("circle.country")
                .data(data)
                .attr("r", function(d){
                  if (country_sum[d.country]) {
                    return rScale(Math.sqrt(country_sum[d.country]));
                  } else {
                    return 0;
                  }
                })
                .on('mouseover', tip.show) //tooltip 
                .on('mouseout', tip.hide); // tooltip 
                
              }); //end of d3.csv

          });//end of d3 county 
        }; //end of function change
      dropdown.on("change", change);
      

      }); //end world json


      d3.select(self.frameElement).style("height", height + "px");

    </script>

    <select id="country-list" name="country-list">
      <option value="Albania">Albania</option>
      <option value="Algeria">Algeria</option>
      <option value="Antigua_and_Barbuda">Antigua and Barbuda</option>
      <option value="Argentina">Argentina</option>
      <option value="Armenia">Armenia</option>
      <option value="Aruba">Aruba</option>
      <option value="Australia">Australia</option>
      <option value="Austria">Austria</option>
      <option value="Azerbaijan">Azerbaijan</option>
      <option value="Bahrain">Bahrain</option>
      <option value="Barbados">Barbados</option>
      <option value="Belarus">Belarus</option>
      <option value="Belgium">Belgium</option>
      <option value="Bolivia">Bolivia</option>
      <option value="Bosnia_Herzegovina">Bosnia Herzegovina</option>
      <option value="Brazil">Brazil</option>
      <option value="Brunei_Darussalam">Brunei Darussalam</option>
      <option value="Bulgaria">Bulgaria</option>
      <option value="Burkina_Faso">Burkina Faso</option>
      <option value="Burundi">Burundi</option>
      <option value="Cabo_Verde">Cabo Verde</option>
      <option value="Cameroon">Cameroon</option>
      <option value="Canada">Canada</option>
      <option value="Central_African_Rep">Central African Republic</option>
      <option value="Chile">Chile</option>
      <option value="China">China</option>
      <option value="Colombia">Colombia</option>
      <option value="Croatia">Croatia</option>
      <option value="Cyprus">Cyprus</option>
      <option value="Czech_Rep">Czech Republic</option>
      <option value="Denmark">Denmark</option>
      <option value="Dominica">Dominica</option>
      <option value="Dominican_Rep">Dominican Republic</option>
      <option value="Ecuador">Ecuador</option>
      <option value="Egypt">Egypt</option>
      <option value="El_Salvador">El Salvador</option>
      <option value="Estonia">Estonia</option>
      <option value="Ethiopia">Ethiopia</option>
      <option value="Finland">Finland</option>
      <option value="France">France</option>
      <option value="Georgia">Georgia</option>
      <option value="Germany">Germany</option>
      <option value="Greece">Greece</option>
      <option value="Guatemala">Guatemala</option>
      <option value="Hong_Kong">Hong Kong SAR</option>
      <option value="Hungary">Hungary</option>
      <option value="Iceland">Iceland</option>
      <option value="India">India</option>
      <option value="Indonesia">Indonesia</option>
      <option value="Ireland">Ireland</option>
      <option value="Israel">Israel</option>
      <option value="Italy">Italy</option>
      <option value="Japan">Japan</option>
      <option value="Jordan">Jordan</option>
      <option value="Kazakhstan">Kazakhstan</option>
      <option value="Kenya">Kenya</option>
      <option value="Kyrgyzstan">Kyrgyzstan</option>
      <option value="Latvia">Latvia</option>
      <option value="Lithuania">Lithuania</option>
      <option value="Luxembourg">Luxembourg</option>
      <option value="Macedonia">Macedonia</option>
      <option value="Madagascar">Madagascar</option>
      <option value="Malaysia">Malaysia</option>
      <option value="Mali">Mali</option>
      <option value="Malta">Malta</option>
      <option value="Mauritius">Mauritius</option>
      <option value="Mexico">Mexico</option>
      <option value="Montenegro">Montenegro</option>
      <option value="Morocco">Morocco</option>
      <option value="Mozambique">Mozambique</option>
      <option value="Namibia">Namibia</option>
      <option value="Netherlands">Netherlands</option>
      <option value="New_Caledonia">New Caledonia</option>
      <option value="New_Zealand">New Zealand</option>
      <option value="Nicaragua">Nicaragua</option>
      <option value="Nigeria">Nigeria</option>
      <option value="Norway">Norway</option>
      <option value="Pakistan">Pakistan</option>
      <option value="Panama">Panama</option>
      <option value="Paraguay">Paraguay</option>
      <option value="Peru">Peru</option>
      <option value="Philippines">Philippines</option>
      <option value="Poland">Poland</option>
      <option value="Portugal">Portugal</option>
      <option value="Rep_of_Korea">Republic of Korea</option>
      <option value="Rep_of_Moldova">Republic of Moldova</option>
      <option value="Romania">Romania</option>
      <option value="Russian_Federation">Russian Federation</option>
      <option value="Rwanda">Rwanda</option>
      <option value="Senegal">Senegal</option>
      <option value="Serbia">Serbia</option>
      <option value="Singapore">Singapore</option>
      <option value="Slovakia">Slovakia</option>
      <option value="Slovenia">Slovenia</option>
      <option value="South_Africa">South Africa</option>
      <option value="Spain">Spain</option>
      <option value="Sri_Lanka">Sri Lanka</option>
      <option value="State_of_Palestine">State of Palestine</option>
      <option value="Sweden">Sweden</option>
      <option value="Switzerland">Switzerland</option>
      <option value="Thailand">Thailand</option>
      <option value="Togo">Togo</option>
      <option value="Turkey">Turkey</option>
      <option value="Ukraine">Ukraine</option>
      <option value="United_Kingdom">United Kingdom</option>
      <option value="United_Rep_of_Tanzania">United Republic of Tanzania</option>
      <option value="Uruguay">Uruguay</option>
      <option value="USA">USA</option>
      <option value="Zambia">Zambia</option>
      <option value="Zimbabwe">Zimbabwe</option>
    </select>

    </div><!-- /.container -->

    <script type="text/javascript" id="line_chart">
      var range_max,
          range_min;

//___Initial Draw with Albania
       d3.json("data/country_json/albania.json", function(error, data){

        var margin = {top: 15, right: 14, bottom: 50, left: 80},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        var x = d3.time.scale()
            .domain([new Date(2009, 11) , new Date(2013, 11)])
            .range([0, width]);

        var brush = d3.svg.brush()
            .x(x)
            .on("brushend", brushended);

        var svg = d3.select("body").append("svg").attr("id","line_graph")
            .attr("class","line_chart")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("class","whole")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        //Line Graph vars
        //some type of if function here to adjust the input if it is weight of value input
        var max = d3.max(d3.max(data, function(d){ if (d.partner_country == undefined){return d.net_weight;};}));

      //Y-Scale Function Defined based on max 
        var yScale = d3.scale
                      .linear()
                      .domain([0,max]).nice() //.nice to round up! 
                      .range([height,0]);

      //Create the array for x date values: 
       date_range = [new Date(2009, 12), new Date(2010, 1), new Date(2010, 2), new Date(2010, 3), new Date(2010, 4), new Date(2010, 5), new Date(2010, 6), new Date(2010, 7), new Date(2010, 8), new Date(2010, 9), new Date(2010, 10), new Date(2010, 11), new Date(2010, 12), new Date(2011, 1), new Date(2011, 2), new Date(2011, 3), new Date(2011, 4), new Date(2011, 5), new Date(2011, 6), new Date(2011, 7), new Date(2011, 8), new Date(2011, 9), new Date(2011, 10), new Date(2011, 11), new Date(2011, 12),new Date(2012, 1), new Date(2012, 2), new Date(2012, 3), new Date(2012, 4), new Date(2012, 5), new Date(2012, 6), new Date(2012, 7), new Date(2012, 8), new Date(2012, 9), new Date(2012, 10), new Date(2012, 11), new Date(2012, 12),new Date(2013, 1), new Date(2013, 2), new Date(2013, 3), new Date(2013, 4), new Date(2013, 5), new Date(2013, 6), new Date(2013, 7), new Date(2013, 8), new Date(2013, 9), new Date(2013, 10), new Date(2013, 11)]  ;
 

        //Grid lines
        svg.append("g")
            .attr("class", "x grid")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.svg.axis()
                .scale(x)
                .orient("bottom")
                .ticks(d3.time.month)
                .tickSize(-height)
                .tickFormat(""))

        svg.append("g")
            .attr("class", "y grid")
            .call(d3.svg.axis()
                .scale(yScale)
                .orient("left")
                .tickSize(-width)
                .tickFormat(""));

      //Drawing the line function + call
      var line = d3.svg.line().x(function(d,i) { return x(date_range[i]); })
                        .y(function(d) {  return yScale(d); });
      //line for each partner country
      svg.selectAll("line").data(data).enter()
                         .append("path")
                         .attr("d", function(d) {if (d.partner_country != undefined) {return line(d.net_weight);};})   
                         .attr("stroke", "gray")
                         .attr("stroke-width", 1)
                         .attr("fill", "none");
     //Aggregate line for reporting country
      svg.selectAll("line").data(data).enter()
                         .append("path")
                         .attr("d", function(d) {if (d.partner_country == undefined) {return line(d.net_weight);};})   
                         .attr("stroke", "red")
                         .attr("stroke-width", 1)
                         .attr("fill", "none");

        //y-axis
        var yAxis = d3.svg.axis();
        yAxis.scale(yScale).orient("left").ticks(10);
        svg.append("g").attr("class","y axis")
            .attr("transform", "translate(" - margin.right + ",0)").call(yAxis);

        //x-axis
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.svg.axis()
              .scale(x)
              .orient("bottom")
              .ticks(d3.time.month,2)
              .tickFormat(d3.time.format("%m/%y"))
              .tickPadding(0))
          .selectAll("text")
            .attr("x", -15)
            .style("text-anchor", null);

        //Highlight brushed area
        var gBrush = svg.append("g")
            .attr("class", "brush")
            .call(brush)
            .call(brush.event);

        gBrush.selectAll("rect")
            .attr("height", height);

        //Brushing function with snapping
        function brushended() {
          if (!d3.event.sourceEvent) return; // only transition after input
          var extent0 = brush.extent(),
              extent1 = extent0.map(d3.time.month.round);
     
               // if empty when rounded, use floor & ceil instead
               if (extent1[0] >= extent1[1]) {
                      extent1[0] = d3.time.month.floor(extent0[0]);
                      extent1[1] = d3.time.month.ceil(extent0[1]);			  
                        };
  	      range_min = extent1[0];
  	      range_max = extent1[1];	

          d3.select(this).transition()
             .call(brush.extent(extent1))
             .call(brush.event);					 
      };
	});



//____UPDATED Draw with selected country -- issue is i'm not getting global variable. Can fix by moving the code into the above code, but may not need to (ask Richard.) This way is preferred for neatness. 
       d3.json(jsonFilename, function(error, data){
        d3.select("#line_graph").remove().transition(); //Transition so that it redraws graph in same place

        var margin = {top: 15, right: 14, bottom: 50, left: 80},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        var x = d3.time.scale()
            .domain([new Date(2009, 11) , new Date(2013, 11)])
            .range([0, width]);

        var brush = d3.svg.brush()
            .x(x)
            .on("brushend", brushended);

        var svg = d3.select("body").append("svg").attr("id","line_graph")
            .attr("class","line_chart")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("class","whole")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        //Line Graph vars
        //some type of if function here to adjust the input if it is weight of value input
        var max = d3.max(d3.max(data, function(d){ if (d.partner_country == undefined){return d.net_weight;};}));

      //Y-Scale Function Defined based on max 
        var yScale = d3.scale
                      .linear()
                      .domain([0,max]).nice() //.nice to round up! 
                      .range([height,0]);

      //Create the array for x date values: 
       date_range = [new Date(2009, 12), new Date(2010, 1), new Date(2010, 2), new Date(2010, 3), new Date(2010, 4), new Date(2010, 5), new Date(2010, 6), new Date(2010, 7), new Date(2010, 8), new Date(2010, 9), new Date(2010, 10), new Date(2010, 11), new Date(2010, 12), new Date(2011, 1), new Date(2011, 2), new Date(2011, 3), new Date(2011, 4), new Date(2011, 5), new Date(2011, 6), new Date(2011, 7), new Date(2011, 8), new Date(2011, 9), new Date(2011, 10), new Date(2011, 11), new Date(2011, 12),new Date(2012, 1), new Date(2012, 2), new Date(2012, 3), new Date(2012, 4), new Date(2012, 5), new Date(2012, 6), new Date(2012, 7), new Date(2012, 8), new Date(2012, 9), new Date(2012, 10), new Date(2012, 11), new Date(2012, 12),new Date(2013, 1), new Date(2013, 2), new Date(2013, 3), new Date(2013, 4), new Date(2013, 5), new Date(2013, 6), new Date(2013, 7), new Date(2013, 8), new Date(2013, 9), new Date(2013, 10), new Date(2013, 11)]  ;
 

        //Grid lines
        svg.append("g")
            .attr("class", "x grid")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.svg.axis()
                .scale(x)
                .orient("bottom")
                .ticks(d3.time.month)
                .tickSize(-height)
                .tickFormat(""))

        svg.append("g")
            .attr("class", "y grid")
            .call(d3.svg.axis()
                .scale(yScale)
                .orient("left")
                .tickSize(-width)
                .tickFormat(""));

      //Drawing the line function + call
      var line = d3.svg.line().x(function(d,i) { return x(date_range[i]); })
                        .y(function(d) {  return yScale(d); });
      //line for each partner country
      svg.selectAll("line").data(data).enter()
                         .append("path")
                         .attr("d", function(d) {if (d.partner_country != undefined) {return line(d.net_weight);};})   
                         .attr("stroke", "gray")
                         .attr("stroke-width", 1)
                         .attr("fill", "none");
     //Aggregate line for reporting country
      svg.selectAll("line").data(data).enter()
                         .append("path")
                         .attr("d", function(d) {if (d.partner_country == undefined) {return line(d.net_weight);};})   
                         .attr("stroke", "red")
                         .attr("stroke-width", 1)
                         .attr("fill", "none");

        //y-axis
        var yAxis = d3.svg.axis();
        yAxis.scale(yScale).orient("left").ticks(10);
        svg.append("g").attr("class","y axis")
            .attr("transform", "translate(" - margin.right + ",0)").call(yAxis);

        //x-axis
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.svg.axis()
              .scale(x)
              .orient("bottom")
              .ticks(d3.time.month,2)
              .tickFormat(d3.time.format("%m/%y"))
              .tickPadding(0))
          .selectAll("text")
            .attr("x", -15)
            .style("text-anchor", null);

        //Highlight brushed area
        var gBrush = svg.append("g")
            .attr("class", "brush")
            .call(brush)
            .call(brush.event);

        gBrush.selectAll("rect")
            .attr("height", height);

        //Brushing function with snapping
        function brushended() {
          if (!d3.event.sourceEvent) return; // only transition after input
          var extent0 = brush.extent(),
              extent1 = extent0.map(d3.time.month.round);
     
               // if empty when rounded, use floor & ceil instead
               if (extent1[0] >= extent1[1]) {
                      extent1[0] = d3.time.month.floor(extent0[0]);
                      extent1[1] = d3.time.month.ceil(extent0[1]);			  
                        };
  	      range_min = extent1[0];
  	      range_max = extent1[1];	

          d3.select(this).transition()
             .call(brush.extent(extent1))
             .call(brush.event);					 
      };
	});
							 
    </script>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- dropdown menu event listener OLD PLACEHOLDER -->
    
  </body>
</html>

